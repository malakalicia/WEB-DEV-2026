<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartHR - Recrutement Intelligent</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Archivo:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/style.css">
    <style>
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }

        .page-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .page-subtitle {
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .search-section {
            background: var(--white);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
            padding: 32px;
            margin-bottom: 32px;
        }

        .search-section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .search-section-title svg {
            width: 24px;
            height: 24px;
            color: var(--primary-500);
        }

        .search-form {
            display: flex;
            gap: 16px;
            align-items: flex-end;
        }

        .search-form .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        .result-section {
            background: var(--white);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
            padding: 32px;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .result-title {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .result-title svg {
            width: 24px;
            height: 24px;
            color: var(--success-500);
        }

        .empty-result {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-result svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-result p {
            font-size: 16px;
            margin-bottom: 8px;
        }

        .empty-result span {
            font-size: 14px;
        }

        /* Candidat Card */
        .candidat-card {
            display: none;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }

        .candidat-card.show {
            display: block;
        }

        .candidat-header {
            background: linear-gradient(135deg, #636AE8, #3B82F6);
            padding: 24px;
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .candidat-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .candidat-avatar {
            width: 72px;
            height: 72px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 700;
            border: 3px solid rgba(255, 255, 255, 0.3);
        }

        .candidat-details h3 {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .candidat-details p {
            font-size: 14px;
            opacity: 0.9;
        }

        .compatibility-badge {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 16px 24px;
            text-align: center;
        }

        .compatibility-percent {
            font-size: 36px;
            font-weight: 700;
            line-height: 1;
        }

        .compatibility-label {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 4px;
        }

        .candidat-body {
            padding: 24px;
        }

        .candidat-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
            margin-bottom: 24px;
        }

        .candidat-stat {
            text-align: center;
            padding: 20px;
            background: var(--neutral-50);
            border-radius: var(--radius-md);
        }

        .candidat-stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-500);
        }

        .candidat-stat-label {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .candidat-comment {
            background: var(--neutral-50);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 24px;
        }

        .candidat-comment-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .candidat-comment-text {
            font-size: 14px;
            color: var(--text-primary);
            line-height: 1.6;
        }

        .candidat-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .btn-propose {
            background: var(--success-500);
            color: var(--success-800);
            font-weight: 600;
        }

        .btn-propose:hover {
            background: var(--success-600);
        }

        /* Loading state */
        .loading-state {
            display: none;
            text-align: center;
            padding: 60px 20px;
        }

        .loading-state.show {
            display: block;
        }

        .spinner-large {
            width: 48px;
            height: 48px;
            border: 4px solid var(--neutral-200);
            border-top-color: var(--primary-500);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Success message */
        .success-message {
            display: none;
            background: #DCFCE7;
            border: 1px solid #16A34A;
            border-radius: var(--radius-md);
            padding: 16px 20px;
            margin-top: 16px;
        }

        .success-message.show {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .success-message svg {
            width: 24px;
            height: 24px;
            color: #16A34A;
            flex-shrink: 0;
        }

        .success-message span {
            color: #166534;
            font-weight: 500;
        }

        /* Profil badges */
        .badge-profil {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            background: rgba(255, 255, 255, 0.2);
            margin-top: 8px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header-container">
        <a href="../index.html" class="header-logo">
            <svg class="logo-svg" viewBox="0 0 50 50">
                <circle cx="25" cy="25" r="22" fill="#636AE8"/>
                <text x="25" y="32" font-family="Arial" font-size="14" font-weight="bold" fill="white" text-anchor="middle">HR</text>
            </svg>
            <span class="header-title">SmartHR</span>
        </a>

        <nav class="header-menu">
            <a href="besoins.html" class="header-menu-item">Besoins</a>
            <a href="candidats.html" class="header-menu-item">Candidats</a>
            <a href="recrutement-intelligent.html" class="header-menu-item active">Recrutement intelligent</a>
        </nav>

        <button class="btn-disconnect" onclick="Auth.logout()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                <polyline points="16 17 21 12 16 7"/>
                <line x1="21" y1="12" x2="9" y2="12"/>
            </svg>
            Se deconnecter
        </button>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="page-header">
            <div>
                <h1 class="page-title">Recrutement Intelligent</h1>
                <p class="page-subtitle">Trouvez le candidat ideal grace a notre algorithme de matching IA</p>
            </div>
        </div>

        <!-- Section de recherche -->
        <div class="search-section">
            <h2 class="search-section-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/>
                    <path d="M21 21l-4.35-4.35"/>
                </svg>
                Rechercher un candidat par besoin
            </h2>

            <div class="search-form">
                <div class="form-group">
                    <label class="form-label">Selectionnez un besoin</label>
                    <select class="form-select" id="besoinSelect">
                        <option value="">Choisir un besoin...</option>
                    </select>
                </div>
                <button class="btn btn-primary btn-lg" onclick="searchCandidat()" id="searchBtn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                    </svg>
                    Rechercher via IA
                </button>
            </div>
        </div>

        <!-- Section resultat -->
        <div class="result-section">
            <div class="result-header">
                <h2 class="result-title">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="8.5" cy="7" r="4"/>
                        <path d="M20 8v6"/>
                        <path d="M23 11h-6"/>
                    </svg>
                    Candidat recommande
                </h2>
            </div>

            <!-- Etat vide -->
            <div id="emptyState" class="empty-result">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                </svg>
                <p>Aucun candidat selectionne</p>
                <span>Selectionnez un besoin et cliquez sur "Rechercher via IA" pour trouver le candidat ideal</span>
            </div>

            <!-- Etat chargement -->
            <div id="loadingState" class="loading-state">
                <div class="spinner-large"></div>
                <p style="font-weight: 500; color: var(--text-primary);">Analyse en cours...</p>
                <span style="color: var(--text-secondary);">Notre algorithme recherche le meilleur candidat</span>
            </div>

            <!-- Carte candidat -->
            <div id="candidatCard" class="candidat-card">
                <div class="candidat-header">
                    <div class="candidat-info">
                        <div class="candidat-avatar" id="candidatAvatar">ME</div>
                        <div class="candidat-details">
                            <h3 id="candidatName">Mohamed El Alami</h3>
                            <p id="candidatEmail">mohamed@email.com</p>
                            <span class="badge-profil" id="candidatProfil">Developpeur</span>
                        </div>
                    </div>
                    <div class="compatibility-badge">
                        <div class="compatibility-percent" id="compatibilityPercent">85%</div>
                        <div class="compatibility-label">Compatibilite</div>
                    </div>
                </div>

                <div class="candidat-body">
                    <div class="candidat-grid">
                        <div class="candidat-stat">
                            <div class="candidat-stat-value" id="candidatExperience">5</div>
                            <div class="candidat-stat-label">Annees d'experience</div>
                        </div>
                        <div class="candidat-stat">
                            <div class="candidat-stat-value" id="candidatStatut">Senior</div>
                            <div class="candidat-stat-label">Niveau de qualification</div>
                        </div>
                        <div class="candidat-stat">
                            <div class="candidat-stat-value" id="candidatProposition">Mission A</div>
                            <div class="candidat-stat-label">Proposition actuelle</div>
                        </div>
                    </div>

                    <div class="candidat-comment">
                        <div class="candidat-comment-label">Commentaire</div>
                        <div class="candidat-comment-text" id="candidatComment">Excellent profil technique avec une bonne experience en developpement.</div>
                    </div>

                    <div class="candidat-actions">
                        <button class="btn btn-secondary" onclick="resetSearch()">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                                <path d="M3 3v5h5"/>
                            </svg>
                            Nouvelle recherche
                        </button>
                        <button class="btn btn-propose" onclick="proposerEntretien()" id="proposeBtn">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 2L11 13"/>
                                <path d="M22 2L15 22l-4-9-9-4 20-7z"/>
                            </svg>
                            Proposer entretien
                        </button>
                    </div>

                    <div id="successMessage" class="success-message">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                            <polyline points="22 4 12 14.01 9 11.01"/>
                        </svg>
                        <span id="successText">Email envoye avec succes au candidat !</span>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer-container">
        <div class="footer-left">
            <span class="footer-text">2025 SmartHR. Tous droits reserves.</span>
        </div>
        <div class="footer-right">
            <a href="#" class="footer-link">Aide</a>
            <a href="#" class="footer-link">Contact</a>
        </div>
    </footer>

    <script src="../js/api-simulator.js"></script>
    <script>
        // Variables globales
        let besoins = [];
        let currentCandidat = null;

        // Labels
        const profilsLabels = ['Developpeur', 'Data Scientist', 'DevOps', 'Chef de Projet', 'Designer'];
        const statutsLabels = ['Junior', 'Intermediaire', 'Senior', 'Expert'];

        // Initialisation
        document.addEventListener('DOMContentLoaded', async function() {
            // Verifier l'authentification
            if (!Auth.checkAuth()) return;

            // Charger les besoins
            await loadBesoins();
        });

        // Charger les besoins depuis l'API
        async function loadBesoins() {
            try {
                const response = await HTTP.getBesoins();

                if (response.result === false) {
                    window.location.href = '../index.html';
                    return;
                }

                besoins = response.besoins || [];
                populateBesoinSelect();
            } catch (error) {
                console.error('Erreur chargement besoins:', error);
                showNotification('Erreur lors du chargement des besoins', 'error');
            }
        }

        // Remplir le select des besoins
        function populateBesoinSelect() {
            const select = document.getElementById('besoinSelect');
            const niveauxLabels = ['Faible', 'Moyen', 'Urgent'];

            // Filtrer pour n'afficher que les besoins ouverts (statut = 0)
            const besoinsOuverts = besoins.filter(b => b.statut === 0);

            besoinsOuverts.forEach(besoin => {
                const option = document.createElement('option');
                option.value = besoin.id;
                option.textContent = `${besoin.poste} - ${besoin.competences.slice(0, 2).join(', ')} (${niveauxLabels[besoin.niveau]})`;
                select.appendChild(option);
            });
        }

        // Rechercher candidat via IA
        async function searchCandidat() {
            const besoinId = document.getElementById('besoinSelect').value;

            if (!besoinId) {
                showNotification('Veuillez selectionner un besoin', 'error');
                return;
            }

            // Afficher l'etat de chargement
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('candidatCard').classList.remove('show');
            document.getElementById('loadingState').classList.add('show');
            document.getElementById('searchBtn').disabled = true;

            try {
                // Appel API: GET http://localhost:3000/api/candidats/par_besoin/:id_besoin
                const response = await HTTP.getCandidatParBesoin(besoinId);

                // Masquer le chargement
                document.getElementById('loadingState').classList.remove('show');
                document.getElementById('searchBtn').disabled = false;

                if (response.result === false || !response.id) {
                    document.getElementById('emptyState').style.display = 'block';
                    showNotification('Aucun candidat trouve pour ce besoin', 'warning');
                    return;
                }

                // Stocker le candidat courant
                currentCandidat = response;

                // Afficher le candidat
                displayCandidat(response);

            } catch (error) {
                console.error('Erreur recherche:', error);
                document.getElementById('loadingState').classList.remove('show');
                document.getElementById('emptyState').style.display = 'block';
                document.getElementById('searchBtn').disabled = false;
                showNotification('Erreur lors de la recherche', 'error');
            }
        }

        // Afficher le candidat
        function displayCandidat(candidat) {
            // Avatar (initiales)
            const initials = candidat.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
            document.getElementById('candidatAvatar').textContent = initials;

            // Informations
            document.getElementById('candidatName').textContent = candidat.name;
            document.getElementById('candidatEmail').textContent = candidat.email;
            document.getElementById('candidatProfil').textContent = profilsLabels[candidat.profil] || 'N/A';
            document.getElementById('compatibilityPercent').textContent = candidat.percent + '%';

            // Stats
            document.getElementById('candidatExperience').textContent = candidat.experience;
            document.getElementById('candidatStatut').textContent = statutsLabels[candidat.statut] || 'N/A';
            document.getElementById('candidatProposition').textContent = candidat.proposition;

            // Commentaire
            document.getElementById('candidatComment').textContent = candidat.commentaire || 'Aucun commentaire disponible.';

            // Reinitialiser le bouton et le message de succes
            document.getElementById('proposeBtn').disabled = false;
            document.getElementById('successMessage').classList.remove('show');

            // Afficher la carte
            document.getElementById('candidatCard').classList.add('show');
        }

        // Proposer entretien
        async function proposerEntretien() {
            if (!currentCandidat) return;

            const btn = document.getElementById('proposeBtn');
            btn.disabled = true;
            btn.innerHTML = `
                <span class="spinner" style="width: 16px; height: 16px; border-width: 2px;"></span>
                Envoi en cours...
            `;

            try {
                // Appel API: POST http://localhost:3000/api/candidats/send_mail/:id_candidat
                const response = await HTTP.sendMail(currentCandidat.id);

                if (response.result === true) {
                    // Afficher le message de succes
                    document.getElementById('successText').textContent = response.message || `Email envoye avec succes a ${currentCandidat.email} !`;
                    document.getElementById('successMessage').classList.add('show');

                    btn.innerHTML = `
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="20 6 9 17 4 12"/>
                        </svg>
                        Email envoye
                    `;

                    showNotification('Proposition d\'entretien envoyee !', 'success');
                } else {
                    throw new Error('Echec de l\'envoi');
                }
            } catch (error) {
                console.error('Erreur envoi mail:', error);
                btn.disabled = false;
                btn.innerHTML = `
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 2L11 13"/>
                        <path d="M22 2L15 22l-4-9-9-4 20-7z"/>
                    </svg>
                    Proposer entretien
                `;
                showNotification('Erreur lors de l\'envoi de l\'email', 'error');
            }
        }

        // Reinitialiser la recherche
        function resetSearch() {
            document.getElementById('besoinSelect').value = '';
            document.getElementById('candidatCard').classList.remove('show');
            document.getElementById('emptyState').style.display = 'block';
            document.getElementById('successMessage').classList.remove('show');
            currentCandidat = null;
        }

        // Notification
        function showNotification(message, type = 'success') {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                padding: 16px 24px;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 10000;
                box-shadow: 0 10px 15px rgba(0,0,0,0.1);
                animation: slideIn 0.3s ease;
                background: ${type === 'success' ? '#1DD75B' : type === 'error' ? '#DE3B40' : type === 'warning' ? '#F59E0B' : '#636AE8'};
            `;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Animations
        const styleSheet = document.createElement('style');
        styleSheet.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
            .spinner {
                display: inline-block;
                border: 2px solid rgba(255,255,255,0.3);
                border-top-color: white;
                border-radius: 50%;
                animation: spin 0.8s linear infinite;
            }
        `;
        document.head.appendChild(styleSheet);
    </script>
</body>
</html>
